# CryptoBar V0.99j - Price Precision Fix

## Release Date
2025-12-21

## Overview
This release fixes BTC price precision issues by upgrading all price-related variables from `float` (32-bit) to `double` (64-bit), eliminating the recurring .0000 or .5000 decimal artifacts.

## Problem Statement
Users reported that BTC prices frequently displayed with .0000 or .5000 decimal endings (about 50% of the time), making it appear as if precision was lost or the API was returning rounded values.

**Root Cause:**
- All price variables used `float` (32-bit, ~6-7 significant digits)
- BTC prices like $42,150.23456 require more precision than `float` provides
- Binary floating-point representation caused .0000 or .5000 artifacts

**Example:**
```
Input:  $42,150.234567 (from Binance API)
float:  $42,150.234375 (rounded due to precision limit)
Display: $42,150.0000 or $42,150.5000 (binary float artifacts)
```

## Solution
Upgraded all price-related variables from `float` to `double`:
- **float** (32-bit): ~6-7 significant digits
- **double** (64-bit): ~15-16 significant digits ✓

## Changes

### 1. Core Price Variables (include/app_state.h, src/app_state.cpp)
- `g_lastPriceUsd`: float → double
- `g_lastChange24h`: float → double
- `g_prefetchPrice`: float → double
- `g_prefetchChange`: float → double
- `g_prevDayRefPrice`: float → double

### 2. Data Structures
- `ChartSample.price`: float → double (include/chart.h)
- `MeanSample.price`: float → double (src/day_avg.cpp)

### 3. Function Signatures
All price-related functions updated to use double:
- `fetchPrice(double&, double&)` (src/network.cpp)
- `fetchPriceFromBinance(double&, double&)`
- `fetchPriceFromKraken(double&, double&)`
- `fetchPriceFromPaprika(double&, double&)`
- `fetchPriceFromCoingecko(double&, double&)`
- `drawMainScreen(double, double, bool)` (src/ui.cpp)
- `updateLedForPrice(double, bool)` (src/led_status.cpp)
- `addChartSampleForNow(double)` (src/network.cpp)
- `dayAvgRollingAdd(time_t, double)` (src/day_avg.cpp)
- `dayAvgRollingGet(time_t, double&)`
- `dayAvgCycleMean(double&)`

### 4. Internal Calculations
All intermediate price calculations updated to use double precision throughout the codebase.

## User Benefits
1. **Accurate Price Display**: BTC and other coins display with full precision
2. **No More Artifacts**: Eliminates .0000 and .5000 rounding artifacts
3. **Professional Appearance**: Prices look correct and trustworthy
4. **Better Trading Decisions**: Real-time accurate prices down to the cent

## Technical Details

### Precision Comparison
| Type | Bits | Sig. Digits | BTC Price Example |
|------|------|-------------|-------------------|
| float | 32 | ~6-7 | $42,150.23 (loses precision) |
| double | 64 | ~15-16 | $42,150.234567 (full precision) ✓ |

### Memory Impact
- Negligible: ~200 bytes additional RAM usage
- ESP32-S3 has 512KB SRAM, so this is < 0.04% increase

### Performance Impact
- None: ESP32-S3 has hardware double-precision FPU
- Double operations are just as fast as float on this platform

## Compatibility
- Fully backward compatible with V0.99i
- No settings changes required
- No breaking changes to user configuration

## Migration Notes
Simply flash V0.99j firmware - no additional configuration needed.

## Version History
- V0.99i: Price Update Optimization (API reordering)
- V0.99j: Price Precision Fix (this release)

## Files Modified
- `include/app_state.h`: Price variable declarations
- `src/app_state.cpp`: Price variable definitions, version update
- `include/chart.h`: ChartSample structure
- `include/network.h`: fetchPrice signature
- `include/ui.h`: drawMainScreen signature
- `include/led_status.h`: updateLedForPrice signature
- `include/day_avg.h`: Day average function signatures
- `src/network.cpp`: All price fetch and chart functions
- `src/ui.cpp`: Price display and chart rendering
- `src/led_status.cpp`: LED price indicator
- `src/main.cpp`: Main loop price handling
- `src/day_avg.cpp`: Day average calculations
- `src/app_menu.cpp`: Menu price refresh

## Verification
After flashing V0.99j, you should see:
- BTC prices with accurate decimals (e.g., $42,150.23)
- No more recurring .0000 or .5000 patterns
- Smooth price updates without precision loss
