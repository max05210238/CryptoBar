# CryptoBar V0.99f - Multi-Currency Support

## Overview

V0.99f introduces comprehensive multi-currency support with 9 global currencies, intelligent display formatting, and optimized FX rate fetching. The system automatically adjusts decimal places and font sizes to ensure clean, readable price display across all currencies.

---

## üåç Supported Currencies

| Code | Symbol | Name | Decimal Places | Notes |
|------|--------|------|----------------|-------|
| USD  | $      | US Dollar | 2-4 | Base currency |
| TWD  | NT$    | Taiwan Dollar | 0-2 | Dual-character symbol |
| EUR  | ‚Ç¨      | Euro | 2-4 | |
| GBP  | ¬£      | British Pound | 2-4 | |
| CAD  | C$     | Canadian Dollar | 2-4 | Dual-character symbol |
| JPY  | ¬•      | Japanese Yen | 0 | No decimals (noDecimals flag) |
| KRW  | ‚Ç©      | South Korean Won | 0 | No decimals (noDecimals flag) |
| SGD  | S$     | Singapore Dollar | 2-4 | Dual-character symbol |
| AUD  | A$     | Australian Dollar | 2-4 | Dual-character symbol |

**Total**: 9 currencies covering major global markets

---

## üé® Smart Display Logic

### Adaptive Formatting

The display system intelligently handles different price ranges and currency characteristics:

#### 1. Decimal Place Rules

**JPY and KRW** (noDecimals flag):
- Always display as whole numbers
- Example: ¬•1,234,567

**Other currencies** (up to 4 decimals):
- High-value coins: 2 decimals (e.g., BTC: $45,678.90)
- Mid-value coins: 3 decimals (e.g., ETH: $2,345.678)
- Low-value coins: 4 decimals (e.g., XRP: $0.5432)

#### 2. Font Size Optimization

**Primary font**: 18pt (FreeSansBold18pt7b)
- Used whenever price fits comfortably
- Clean, readable display

**Fallback font**: 12pt (FreeSansBold12pt7b)
- Only used when price is too wide for 18pt
- Triggered by very long numbers (e.g., KRW: ‚Ç©50,123,456)

#### 3. Display Width Management

**Strategy**: Reduce decimals first, downgrade font only when necessary

```cpp
// Priority 1: Try 18pt with reduced decimals
if (width > max_width) {
  decimals--;  // Try fewer decimals
}

// Priority 2: Switch to 12pt only if still too wide
if (width > max_width && decimals == 0) {
  font = FreeSansBold12pt7b;  // Smaller font
}
```

**Benefits**:
- Maintains readability (18pt preferred)
- Gracefully handles edge cases (very large numbers)
- Consistent user experience across currencies

---

## üí± Exchange Rate API

### Dual-Layer Fallback System

#### Primary API: open.er-api.com
- **Rate limit**: 1,500 requests/month (free tier)
- **Currencies**: 160+ supported
- **Reliability**: High uptime
- **Endpoint**: `https://open.er-api.com/v6/latest/USD`

#### Fallback API: fxratesapi.com
- **Rate limit**: Unlimited (free)
- **Currencies**: 170+ supported
- **Reliability**: Good uptime
- **Endpoint**: `https://api.fxratesapi.com/latest?base=USD`

### Update Strategy

**Frequency**: 1 hour (3,600 seconds)
```cpp
g_nextFxUpdateUtc = nowUtc + 3600;  // 1 hour
```

**Monthly usage**:
- Updates per day: 24
- Updates per month: ~720
- API quota usage: 48% of free tier (well within limits)

**Trigger points**:
1. Startup (after WiFi + NTP ready)
2. Every hour during normal operation
3. After NTP time sync events

### Error Handling

**If API fails**:
- Retains last known FX rates
- Continues displaying prices with cached rates
- Logs warning to Serial Monitor
- Retries at next scheduled interval

**Fallback cascade**:
```
open.er-api.com ‚Üí fxratesapi.com ‚Üí cached rates
```

---

## üîß Technical Implementation

### Data Structures

#### CurrencyInfo Struct
```cpp
struct CurrencyInfo {
  const char* code;      // ISO code (USD, EUR, etc.)
  const char* symbol;    // Display symbol ($, ‚Ç¨, etc.)
  const char* name;      // Full name
  bool noDecimals;       // true for JPY, KRW
};
```

#### Global FX Rate Array
```cpp
extern float g_usdToRate[CURR_COUNT];  // Exchange rates for all currencies
extern int g_displayCurrency;          // Currently selected currency (0-8)
extern bool g_fxValid;                 // FX rates are valid
extern time_t g_nextFxUpdateUtc;       // Next scheduled update
```

### Currency Selection

#### Menu Navigation
- Long press encoder ‚Üí Enter settings menu
- Navigate to "Currency" option
- Rotate encoder to cycle through 9 currencies
- Short press to confirm

#### Persistence
- Currency preference saved to NVS (non-volatile storage)
- Survives power cycles and reboots
- Default: USD

---

## üìä Display Examples

### High-Value Coin (BTC)
```
USD:  $45,678.90      (18pt, 2 decimals)
EUR:  ‚Ç¨42,345.67      (18pt, 2 decimals)
JPY:  ¬•6,234,567      (18pt, 0 decimals)
```

### Mid-Value Coin (ETH)
```
USD:  $2,345.678      (18pt, 3 decimals)
GBP:  ¬£1,890.234      (18pt, 3 decimals)
KRW:  ‚Ç©3,123,456      (12pt, 0 decimals) - downgraded font
```

### Low-Value Coin (XRP)
```
USD:  $0.5432         (18pt, 4 decimals)
TWD:  NT$17.23        (18pt, 2 decimals)
AUD:  A$0.8234        (18pt, 4 decimals)
```

---

## üîÑ Migration from V0.99e

### Backward Compatibility

#### Alias for Legacy Code
```cpp
// Old constant (still works)
#define CURR_NTD CURR_TWD

// Old variable access (still works)
#define g_usdToTwd g_usdToRate[CURR_TWD]
```

#### Wrapper Functions
```cpp
// V0.99e
bool fetchUsdToTwdRate();

// V0.99f (internally calls fetchExchangeRates)
bool fetchUsdToTwdRate() {
  return fetchExchangeRates();  // Fetches all currencies
}
```

### Settings Migration
- Existing `g_displayCurrency = CURR_NTD` auto-migrates to `CURR_TWD`
- Settings stored in NVS remain valid
- No user action required

---

## üìù Modified Files

### Core Implementation (10 files changed)

1. **include/config.h** (+36 lines)
   - Added `CurrencyInfo` struct
   - Defined `CURRENCY_INFO[]` array with 9 currencies
   - Added currency enum (CURR_USD, CURR_TWD, etc.)

2. **include/app_state.h** (+8 lines)
   - Declared `g_usdToRate[]` array
   - Declared `g_displayCurrency`, `g_fxValid`, `g_nextFxUpdateUtc`

3. **src/app_state.cpp** (+24 lines)
   - Defined `g_usdToRate[CURR_COUNT]` (initialized to 1.0)
   - Initialized FX-related globals

4. **include/network.h** (+7 lines)
   - Added `fetchExchangeRates()` declaration
   - Updated API documentation

5. **src/network.cpp** (+72 lines)
   - Implemented `fetchExchangeRates()` with dual API support
   - Added JSON parsing for FX rates
   - Implemented error handling and fallback logic

6. **src/ui.cpp** (+105 lines refactored)
   - Enhanced `drawPriceCenter()` with smart formatting
   - Implemented decimal/font downgrade logic
   - Added currency symbol positioning

7. **src/app_menu.cpp** (+13 lines)
   - Updated currency cycling logic (9 options)
   - Added validation for currency index

8. **src/ui_menu.cpp** (+5 lines)
   - Updated currency menu labels

9. **src/settings_store.cpp** (+5 lines)
   - Added currency range validation (0-8)

10. **src/main.cpp** (+45 lines refactored)
    - Integrated FX rate fetching on startup
    - Added periodic FX update logic

**Total changes**: +223 lines, -97 lines (net +126 lines)

---

## üåê API Comparison

| Feature | open.er-api.com | fxratesapi.com |
|---------|----------------|----------------|
| Free tier limit | 1,500 req/month | Unlimited |
| Currencies | 160+ | 170+ |
| Update frequency | Daily | Real-time |
| Authentication | Not required | Not required |
| Response time | <500ms | <800ms |
| Reliability | 99.5% | 98% |
| Data freshness | Daily EOD | Hourly |

**Strategy**: Use open.er-api.com as primary for reliability, fall back to fxratesapi.com for unlimited capacity.

---

## üéØ Benefits

### User Experience
- ‚úÖ Display prices in local currency
- ‚úÖ 9 major global currencies supported
- ‚úÖ Clean, readable formatting for all price ranges
- ‚úÖ No truncation or overflow
- ‚úÖ Persistent currency preference

### Technical
- ‚úÖ Minimal API usage (720 req/month vs 1,500 limit)
- ‚úÖ Dual-layer API fallback for reliability
- ‚úÖ Smart caching (1-hour intervals)
- ‚úÖ Backward compatible with V0.99e
- ‚úÖ Extensible (easy to add more currencies)

### Cost Efficiency
- ‚úÖ 100% free API services
- ‚úÖ No API keys required
- ‚úÖ Well within free tier limits
- ‚úÖ Reduced update frequency (1h vs 5min)

---

## üîÆ Future Enhancements

### Potential Additions
- üåè Additional Asian currencies (HKD, THB, MYR, INR)
- üáßüá∑ Latin American currencies (BRL, MXN, ARS)
- ü™ô Cryptocurrency-to-crypto pairs (ETH/BTC, etc.)
- üìà Historical FX rate charting
- ‚öôÔ∏è User-configurable update intervals

### Advanced Features
- Offline mode with longer caching
- Manual FX rate refresh button
- FX rate change alerts
- Multi-currency portfolio view

---

## üß™ Testing Recommendations

### Test Currency Switching
1. Enter settings menu (long press encoder)
2. Navigate to "Currency"
3. Rotate through all 9 options
4. Verify correct symbols and codes display

### Test Price Display
For each currency:
- High-value coin (BTC): Check 18pt font, 2 decimals
- Mid-value coin (ETH): Check 18pt font, 3 decimals
- Low-value coin (XRP): Check 18pt font, 4 decimals
- JPY/KRW: Verify 0 decimals

### Test FX Rate Fetching
1. Monitor Serial output for `[FX]` messages
2. Verify rates fetched on startup
3. Check 1-hour update interval
4. Test WiFi disconnect recovery

---

## üìö Related Documentation

- **V0.99h_LED_OPTIMIZATION.md**: LED display improvements
- **V0.99g_API_OPTIMIZATION.md**: Binance API 4-layer fallback
- **ENCODER_V099a_RELEASE_NOTES.md**: Encoder fixes

---

## üôè Acknowledgments

Multi-currency support was added based on user requests for:
1. Display prices in local currency (TWD, EUR, etc.)
2. Better formatting for different price ranges
3. Support for Asian markets (JPY, KRW, SGD)

Special thanks to users who provided feedback on decimal place handling and font sizing!

---

**Version**: V0.99f
**Release Date**: 2025-12-20
**Commits**:
- `71d2827` - Initial multi-currency implementation
- `653cb22` - Complete currency submenu and display fixes
- `997d4c3` - UI optimization for cleaner currency display

**Status**: ‚úÖ Merged to main
**Compatibility**: ESP32-S3, backward compatible with V0.99e
