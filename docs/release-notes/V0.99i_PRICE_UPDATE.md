# CryptoBar V0.99i - Price Update Optimization

## Release Date
2025-12-21

## Overview
This release addresses price update delay issues by optimizing the API provider fallback order and implementing intelligent duplicate price detection.

## Problem Statement
Users reported experiencing 3-5 minute delays in price updates despite the device fetching prices every 30 seconds. The issue was caused by:
1. Slow API providers being used as primary data source
2. No detection mechanism for stale/cached API responses
3. Unnecessary screen refreshes when prices haven't changed

## Changes

### 1. API Provider Reordering (src/network.cpp:405-408)
**Before:** CoinPaprika → Binance → CoinGecko → Kraken
**After:** Binance → Kraken → CoinPaprika → CoinGecko

**Rationale:**
- **Binance & Kraken** are real-time exchange APIs with near-instant updates (< 5 seconds)
- **CoinPaprika & CoinGecko** are aggregator APIs with server-side caching (2-5 minute delays)

### 2. Duplicate Price Detection (src/main.cpp:355-357, 758-776)
- Tracks consecutive identical price updates for diagnostics
- Logs warnings when price unchanged for 3+ updates (indicates stale API data)
- Logs price changes with before/after comparison for debugging
- **Display always refreshes** to maintain synchronized appearance across multiple devices

## User Benefits
1. **Faster Price Updates:** Real-time exchange APIs provide data within seconds
2. **Better Diagnostics:** Serial logs now show when prices are stale vs. actually unchanged
3. **Synchronized Display:** All devices refresh together, maintaining consistent visual experience

## Serial Output Examples

### Duplicate Price Detection
```
[Price] Duplicate #1: $42150.230000 (no change)
[Price] Duplicate #2: $42150.230000 (no change)
[Price] Duplicate #3: $42150.230000 (no change)
[Price] WARNING: Price unchanged for 3 updates - possible stale API data
```

### Price Change After Duplicates
```
[Price] CHANGED after 5 duplicates: $42150.230000 -> $42165.780000
```

## Technical Details

### Price Comparison
- Uses epsilon tolerance (0.0001) for floating-point comparison
- Prevents false positives from rounding errors
- Logging only - does not affect display refresh behavior

### Display Refresh Strategy
- **Always refreshes** on every price update cycle
- Maintains synchronized appearance across multiple devices
- Preserves the carefully designed multi-device experience

## Compatibility
- Fully backward compatible with V0.99h
- No settings changes required
- No breaking changes to user configuration

## Migration Notes
Simply flash V0.99i firmware - no additional configuration needed.

## Version History
- V0.99h: LED Optimization with Party Mode
- V0.99i: Price Update Optimization (this release)

## Files Modified
- `src/main.cpp`: Added duplicate detection logic and smart refresh
- `src/network.cpp`: Reordered API fallback for faster updates
- `src/app_state.cpp`: Updated version to V0.99i
