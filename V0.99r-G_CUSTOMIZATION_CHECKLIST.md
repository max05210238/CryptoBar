# V0.99r-G Customization Checklist

## üìã Purpose
This document lists ALL modifications needed when creating a G-version (4-color e-paper) from any standard version.

**Use Case**: When upgrading from V0.99s to V0.99s-G, follow this checklist to ensure all customizations are applied.

---

## ‚úÖ Required Changes

### 1. Display Driver Library
**Replace GxEPD2 with WaveShare EPD_2in9g driver**

#### Files to Modify:
- `include/app_state.h` (line 6-7)
- `src/main.cpp` (display include and object declaration)
- `src/ui.cpp`
- `src/ui_coin.cpp`
- `src/ui_currency.cpp`
- `src/ui_list.cpp`
- `src/ui_menu.cpp`
- `src/ui_timezone.cpp`
- `src/ui_update.cpp`

**Change:**
```cpp
// FROM (V0.99r - black/white):
#include <GxEPD2_3C.h>
extern GxEPD2_3C<GxEPD2_290c, GxEPD2_290c::HEIGHT> display;

// TO (V0.99r-G - 4-color):
#include "../lib/EPD_2in9g/EPD_GxEPD2_Compat.h"
extern EPD_GxEPD2_Compat display;
```

---

### 2. Default Update Interval
**Change from 30 seconds to 5 minutes**

#### File: `include/config.h` (lines 6-8)

**Change:**
```cpp
// FROM (V0.99r):
// V0.99k: Default update interval: 30 seconds
// CoinPaprika (aggregated market data) updates every 30 seconds
static const uint32_t UPDATE_INTERVAL_MS = 30UL * 1000UL;  // 30 seconds

// TO (V0.99r-G):
// V0.99r-G: Default update interval: 5 minutes (for 4-color e-paper)
// 4-color e-paper refresh is slow (15-20 seconds), so 5-minute update is more reasonable
static const uint32_t UPDATE_INTERVAL_MS = 5UL * 60UL * 1000UL;  // 5 minutes
```

**Reason**: 4-color display refresh takes 15-20 seconds with flashing, so frequent updates are not practical.

---

### 3. Per-Minute Time Refresh
**Disable independent time refresh feature**

#### File: `src/app_state.cpp` (line 208)

**Change:**
```cpp
// FROM (V0.99r):
bool   g_timeRefreshEnabled = true;

// TO (V0.99r-G):
bool   g_timeRefreshEnabled = false;  // V0.99r-G: Disabled (4-color e-paper has no partial refresh)
```

**Reason**: 4-color e-paper doesn't support partial refresh. Per-minute time updates would cause full screen refresh every minute (15-20s flashing), which is unacceptable UX.

**Side Effect**: Time display shows the timestamp of last price update, not current time. User is aware of this limitation.

---

### 4. Version String
**Add "-G" suffix to version**

#### File: `src/app_state.cpp` (lines 1, 7)

**Change:**
```cpp
// FROM (V0.99r):
// CryptoBar V0.99r (...)
const char* CRYPTOBAR_VERSION = "V0.99r";

// TO (V0.99r-G):
// CryptoBar V0.99r-G (4-Color E-Paper Support: WaveShare 2.9" Module G)
const char* CRYPTOBAR_VERSION = "V0.99r-G";
```

**Reason**: Clearly identify devices using 4-color display in splash screen and settings menu.

---

## üîß Critical Technical Details

### Display Driver Differences

| Aspect | V0.99r (GxEPD2) | V0.99r-G (WaveShare) |
|--------|-----------------|----------------------|
| **Library** | GxEPD2_3C | EPD_2in9g + Paint library |
| **Resolution** | 296√ó128 (landscape) | 296√ó128 (landscape) |
| **Colors** | Black/White/Red (3-color) | Black/White/Red/Yellow (4-color) |
| **Partial Refresh** | ‚úÖ Supported | ‚ùå NOT supported |
| **Refresh Time** | ~2 seconds | 15-20 seconds (with flashing) |
| **Rotation** | Handled by GxEPD2 | Handled by Paint library (90¬∞) |
| **Color Mode** | Scale=2 (1 bpp) | Scale=4 (2 bpp) |
| **Buffer Size** | Auto-calculated | 9,472 bytes (128/4 √ó 296) |

### WaveShare Driver Configuration

**Critical settings in `lib/EPD_2in9g/EPD_GxEPD2_Compat.h`:**

```cpp
// Physical dimensions (portrait mode)
EPD_2IN9G_WIDTH = 128
EPD_2IN9G_HEIGHT = 296

// Initialization (90¬∞ rotation for landscape)
Paint_NewImage(imageBuffer, EPD_2IN9G_WIDTH, EPD_2IN9G_HEIGHT, 90, EPD_2IN9G_WHITE);
Paint_SetScale(4);  // CRITICAL: 4-color mode (2 bits per pixel)
```

**Pin Configuration in `lib/EPD_2in9g/DEV_Config.h`:**
```cpp
#define EPD_SCK_PIN     12
#define EPD_MOSI_PIN    11
#define EPD_CS_PIN      10
#define EPD_RST_PIN     16
#define EPD_DC_PIN      17
#define EPD_BUSY_PIN    4
// EPD_PWR_PIN: Not used in CryptoBar
```

---

## üìÇ Files Modified (Complete List)

### Display Driver Changes (8 files):
1. `include/app_state.h`
2. `src/main.cpp`
3. `src/ui.cpp`
4. `src/ui_coin.cpp`
5. `src/ui_currency.cpp`
6. `src/ui_list.cpp`
7. `src/ui_menu.cpp`
8. `src/ui_timezone.cpp`
9. `src/ui_update.cpp`

### Configuration Changes (2 files):
1. `include/config.h` - UPDATE_INTERVAL_MS
2. `src/app_state.cpp` - g_timeRefreshEnabled, CRYPTOBAR_VERSION

### WaveShare Driver Library (entire directory):
- `lib/EPD_2in9g/` (all files)

---

## üöÄ Upgrade Procedure

When upgrading from V0.99x to V0.99x-G:

```bash
# 1. Checkout the G-version branch
git checkout claude/4color-display-V099r-G-K0kQP

# 2. Merge the new standard version (e.g., V0.99s)
git merge main  # or specific version tag

# 3. Resolve conflicts (if any), prioritizing G-version settings:
#    - Keep UPDATE_INTERVAL_MS = 5 minutes
#    - Keep g_timeRefreshEnabled = false
#    - Keep WaveShare driver includes
#    - Keep "-G" version suffix

# 4. Verify all checklist items above

# 5. Test compilation
pio run -t clean
pio run

# 6. Commit with clear message
git commit -m "Merge V0.99s into V0.99s-G (4-color version)"

# 7. Update version in src/app_state.cpp to match (e.g., "V0.99s-G")
```

---

## ‚ö†Ô∏è Common Merge Conflicts

**Expected conflicts when merging from main:**

1. **`include/config.h`** - UPDATE_INTERVAL_MS value
   - **Resolution**: Keep 5 minutes for G-version

2. **`src/app_state.cpp`** - g_timeRefreshEnabled and CRYPTOBAR_VERSION
   - **Resolution**: Keep false and add "-G" suffix

3. **Display driver includes** (if main changes display code)
   - **Resolution**: Keep WaveShare driver, adapt new features to Paint library

4. **UI rendering code** (if main adds new GxEPD2 features)
   - **Resolution**: Translate to Paint library equivalents

---

## üìù Testing Checklist

After merge, verify:

- [ ] Compilation successful
- [ ] Display shows version with "-G" suffix (e.g., "V0.99s-G")
- [ ] Full screen renders correctly (296√ó128, 4 colors)
- [ ] Price updates every 5 minutes (at 0:00, 0:05, 0:10, etc.)
- [ ] Time does NOT update every minute (only with price updates)
- [ ] All menu functions work (coin, currency, timezone, update interval)
- [ ] Network features work (WiFi, API, price fetch)
- [ ] All 4 colors render correctly (black/white/red/yellow)

---

## üìñ Related Documentation

- `WAVESHARE_DRIVER_INTEGRATION.md` - Integration details
- `FIX_PARTIAL_DISPLAY_BUG.md` - Critical bug fix history
- `lib/EPD_2in9g/EPD_GxEPD2_Compat.h` - Driver wrapper implementation

---

**Last Updated**: 2026-01-11
**Current G-Version**: V0.99r-G
**Branch**: `claude/4color-display-V099r-G-K0kQP`
