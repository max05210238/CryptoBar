# CryptoBar V0.99h - LED Display Optimization with Party Mode

## Overview

V0.99h introduces a complete LED display system overhaul with rainbow party mode for celebration, improved error state colors, code refactoring, and better maintainability.

## ðŸŽ‰ New Features

### 1. Party Mode (Rainbow Celebration)

**Trigger**: 24-hour gain â‰¥ +20%
**Exit**: Drops below +15% (5% hysteresis)
**Effect**: Smooth rainbow gradient cycling through full color spectrum

**Technical Details**:
- Cycle period: 2.5 seconds per full rainbow
- Color space: HSV (Hue-Saturation-Value) for smooth transitions
- Transition: Continuous gradient (no jumps or flashing)
- Update rate: 30 Hz for fluid animation
- No breathing effect - pure color rotation

**Color sequence**: Red â†’ Orange â†’ Yellow â†’ Green â†’ Blue â†’ Purple â†’ Red...

**User feedback**:
```
[LED] ðŸŽ‰ Party Mode activated! (+20%)
[LED] Party Mode ended (below +15%)
```

---

## ðŸŽ¨ LED Display Rules (Complete)

### Priority Hierarchy

```
Priority 1: Party Mode (+20%)           ðŸŒˆ Rainbow gradient
Priority 2: API Failure                 ðŸŸ¡ Yellow static
Priority 3: System Config/Maintenance   ðŸŸ£/ðŸ”µ Purple/Blue static
Priority 4: Fast Breathing (â‰¥10%)       ðŸŸ¢/ðŸ”´ + 0.9s breathing
Priority 5: Slow Breathing (5-10%)      ðŸŸ¢/ðŸ”´ + 2.4s breathing
Priority 6: Static (<5%)                ðŸŸ¢/ðŸ”´/âšª Static
```

### Price Trend Display

#### Color Rules (with hysteresis)
- ðŸŸ¢ **Green**: Gain > +0.02% (exit when < +0.005%)
- ðŸ”´ **Red**: Loss < -0.02% (exit when > -0.005%)
- âšª **Gray**: Neutral range (-0.005% ~ +0.005%)

#### Breathing Animation (based on magnitude)
- ðŸ“Š **Static**: |change| < 5%
  - Constant brightness, no animation

- ðŸ« **Slow Breathing**: 5% â‰¤ |change| < 10%
  - Period: 2.4 seconds
  - Brightness: 15% ~ 100% (sine wave)

- ðŸ’¨ **Fast Breathing**: |change| â‰¥ 10%
  - Period: 0.9 seconds
  - Brightness: 15% ~ 100% (sine wave)

### System State Colors

**Design Philosophy**: Red/Green reserved exclusively for price movement

- ðŸŸ¡ **Yellow**: API failure / data invalid (changed from purple)
- ðŸŸ£ **Purple**: WiFi config portal / firmware update mode
- ðŸ”µ **Blue**: System startup / WiFi connecting
- ðŸ©µ **Cyan**: Undefined state / fallback mode (reserved)

---

## ðŸ”§ Technical Improvements

### 1. Code Refactoring

#### Eliminated Code Duplication
**Problem**: `ledAnimLoop()` and `ledAnimTickFromTask()` had 20+ lines of duplicate logic

**Solution**: Extracted common animation logic into `ledAnimUpdate()`
```cpp
// Before: Two separate implementations
void ledAnimLoop() { /* 30 lines */ }
void ledAnimTickFromTask() { /* 25 lines duplicate */ }

// After: Shared logic
static void ledAnimUpdate(bool appRunning, bool priceOk) { /* 30 lines */ }
void ledAnimLoop() { /* calls ledAnimUpdate() */ }
void ledAnimTickFromTask() { /* calls ledAnimUpdate() */ }
```

**Result**: -20 lines, improved maintainability

---

### 2. Improved Code Maintainability

#### Color Constants
**Before**: Hardcoded values scattered across code
```cpp
setLed(150, 0, 0);     // Red - what values are these?
setLed(100, 0, 120);   // Purple - hard to maintain
```

**After**: Named constants
```cpp
static const uint8_t COLOR_RED_R = 150, COLOR_RED_G = 0, COLOR_RED_B = 0;
static const uint8_t COLOR_YELLOW_R = 150, COLOR_YELLOW_G = 150, COLOR_YELLOW_B = 0;
static const uint8_t COLOR_CYAN_R = 0, COLOR_CYAN_G = 150, COLOR_CYAN_B = 150;
// ... etc

setLedRed();    { setLed(COLOR_RED_R, COLOR_RED_G, COLOR_RED_B); }
setLedYellow(); { setLed(COLOR_YELLOW_R, COLOR_YELLOW_G, COLOR_YELLOW_B); }
```

#### Configuration Constants
**Before**: Magic numbers
```cpp
if (nowMs - s_ledAnimLastMs < 33) return; // ~30Hz
```

**After**: Named constants
```cpp
static const uint32_t LED_ANIM_MIN_UPDATE_MS = 33;  // ~30Hz animation rate
static const uint32_t LED_PARTY_PERIOD_MS = 2500;   // 2.5 seconds per rainbow cycle
static const float LED_PARTY_ENTER_THRESH = 20.0f;  // +20% triggers party mode
static const float LED_PARTY_EXIT_THRESH = 15.0f;   // <+15% exits party mode
```

---

### 3. HSV Color Space Implementation

Added `hsvToRgb()` function for smooth rainbow gradients:

```cpp
// h: hue (0.0 - 360.0), s: saturation (0.0 - 1.0), v: value/brightness (0.0 - 1.0)
static void hsvToRgb(float h, float s, float v, uint8_t* r, uint8_t* g, uint8_t* b);
```

**Why HSV?**
- RGB interpolation creates ugly brownish colors
- HSV provides natural rainbow transitions
- Hue rotation (0Â° â†’ 360Â°) gives perfect color wheel

**Party Mode Implementation**:
```cpp
if (s_ledAnimMode == LED_ANIM_PARTY) {
  uint32_t nowMs = millis();
  uint32_t t = nowMs % LED_PARTY_PERIOD_MS;
  float hue = (t / (float)LED_PARTY_PERIOD_MS) * 360.0f;

  uint8_t r, g, b;
  hsvToRgb(hue, 1.0f, 1.0f, &r, &g, &b);  // Full saturation
  setLedScaled(r, g, b, 1.0f);
}
```

---

### 4. New Helper Functions

#### Added to API
```cpp
void setLedYellow();  // For API failures (replaces purple)
void setLedCyan();    // For undefined states
```

#### Enhanced Animation Modes
```cpp
enum LedAnimMode : uint8_t {
  LED_ANIM_SOLID = 0,
  LED_ANIM_BREATHE_SLOW = 1,
  LED_ANIM_BREATHE_FAST = 2,
  LED_ANIM_PARTY = 3  // NEW: Rainbow gradient for +20% gains
};
```

---

## ðŸ“Š Configuration Reference

### LED Thresholds

```cpp
// Price trend entry/exit (hysteresis to prevent oscillation)
const float ENTER = 0.02f;   // Enter red/green: Â±0.02%
const float EXIT  = 0.005f;  // Return to neutral: Â±0.005%

// Breathing animation thresholds
LED_EVENT_SLOW_THRESH = 5.0f;   // Slow breathing: 5%
LED_EVENT_FAST_THRESH = 10.0f;  // Fast breathing: 10%

// Party mode thresholds
LED_PARTY_ENTER_THRESH = 20.0f; // Enter: +20%
LED_PARTY_EXIT_THRESH = 15.0f;  // Exit: +15%
```

### Animation Timing

```cpp
// Breathing periods
LED_BREATHE_SLOW_PERIOD_MS = 2400; // 2.4 seconds
LED_BREATHE_FAST_PERIOD_MS = 900;  // 0.9 seconds
LED_PARTY_PERIOD_MS = 2500;        // 2.5 seconds

// Brightness range for breathing
LED_BREATHE_MIN_FRAC = 0.15f;      // Minimum 15% brightness

// Animation update rate
LED_ANIM_MIN_UPDATE_MS = 33;       // ~30Hz
```

### LED Colors

```cpp
// Price movement colors (dedicated)
COLOR_GREEN:  RGB(0, 150, 0)    // Gains
COLOR_RED:    RGB(150, 0, 0)    // Losses
COLOR_GRAY:   RGB(60, 60, 60)   // Neutral

// System state colors (avoid red/green)
COLOR_YELLOW: RGB(150, 150, 0)  // API failure
COLOR_BLUE:   RGB(0, 0, 150)    // Startup/connecting
COLOR_PURPLE: RGB(100, 0, 120)  // Config/maintenance
COLOR_CYAN:   RGB(0, 150, 150)  // Undefined/fallback
COLOR_WHITE:  RGB(30, 30, 30)   // Low white
```

---

## ðŸ”„ Breaking Changes

### API Failure Color Changed
**Before V0.99h**: API failures showed purple
**After V0.99h**: API failures show yellow

**Reason**: Purple reserved for WiFi config portal and firmware update mode. Yellow is more distinct from price movement colors (red/green).

**Migration**: No code changes needed - automatic

---

## ðŸ“ Modified Files

### Core Implementation
1. **src/led_status.cpp** (+131, -47 lines)
   - Added color constants (8 colors)
   - Implemented `hsvToRgb()` function
   - Added Party Mode animation
   - Extracted `ledAnimUpdate()` common logic
   - Updated API failure color to yellow
   - Added helper functions

2. **include/led_status.h** (+3 declarations)
   - `void setLedYellow();`
   - `void setLedCyan();`
   - Updated documentation comments

---

## ðŸŽ¯ Benefits

### User Experience
- âœ… Celebration feedback for major gains (+20%)
- âœ… Clear visual distinction between price and system states
- âœ… Consistent color language (red/green = price only)
- âœ… Smooth, professional animations

### Code Quality
- âœ… 20+ lines of duplicate code eliminated
- âœ… All magic numbers replaced with named constants
- âœ… Better separation of concerns
- âœ… Easier to tune and customize
- âœ… Self-documenting code

### Maintainability
- âœ… Single source of truth for colors
- âœ… Easy to add new animation modes
- âœ… Simple threshold adjustments
- âœ… Comprehensive inline documentation

---

## ðŸ§ª Testing Recommendations

### Test Party Mode
```cpp
// Simulate +20% gain
g_lastChange24h = 20.5f;
updateLedForPrice(g_lastChange24h, true);
// Should see: [LED] ðŸŽ‰ Party Mode activated! (+20%)
// LED should cycle through rainbow colors
```

### Test Color Accuracy
1. **API Failure**: Disconnect WiFi â†’ LED should show yellow (not purple)
2. **Startup**: Power cycle â†’ LED should show blue during boot
3. **Normal Operation**:
   - +5% gain â†’ Green slow breathing
   - +12% gain â†’ Green fast breathing
   - -8% loss â†’ Red slow breathing

### Verify Smooth Transitions
- Party mode should have NO visible color jumps
- Breathing should be smooth sine wave
- Color changes should be gradual

---

## ðŸ”® Future Enhancements

### Potential Additions
- ðŸŸ  **Orange flashing**: System warning (screen failure, sensor error)
- ðŸ”µðŸ’™ **Blue flashing**: WiFi reconnection attempts
- ðŸŸ¡âš ï¸ **Yellow fast breathing**: Critical system error (watchdog reset)
- ðŸŽŠ **Sparkle effect**: Additional party mode variant

### Configuration Options
- User-selectable party mode threshold (e.g., +10%, +15%, +20%)
- Party mode duration limit (auto-exit after N minutes)
- Rainbow speed adjustment
- Custom color themes

---

## ðŸ“š Related Documentation

- **ENCODER_V099a_RELEASE_NOTES.md**: Encoder optimization
- **V0.99g_API_OPTIMIZATION.md**: Binance API 4-layer fallback
- **V0.99f_CURRENCY_SUPPORT.md**: Multi-currency display
- **LED_DISPLAY_GUIDE.md**: Complete LED behavior reference

---

## ðŸ™ Acknowledgments

This optimization was driven by user feedback requesting:
1. Celebration feedback for significant gains
2. Clearer system error indicators
3. Avoiding color conflicts with price movement

Special thanks for the excellent suggestion to reserve red/green exclusively for price movement!

---

**Version**: V0.99h
**Release Date**: 2025-12-21
**Status**: âœ… Committed and pushed to `claude/optimize-led-display-42jPu`
**Compatibility**: ESP32-S3, backwards compatible with all V0.99x versions
