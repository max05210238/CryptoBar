# V0.99n: API Priority & Update Frequency Optimization

**Release Date**: 2025-12-24
**Focus**: API priority reordering and update frequency optimization for rate limit management

---

## Overview

V0.99n reorders API priority based on service quality assessment and optimizes update frequencies to better manage free-tier rate limits. This release prioritizes CoinGecko as the primary API source and removes the aggressive 30-second update option to reduce API pressure across multi-device deployments.

---

## Key Changes

### 1. API Priority Reordering

**Previous Priority** (V0.99m and earlier):
1. CoinPaprika (Primary)
2. CoinGecko (Fallback 1)
3. Kraken (Fallback 2)
4. Binance (Fallback 3)

**New Priority** (V0.99n):
1. **CoinGecko** (Primary) - Best overall API quality
2. **CoinPaprika** (Fallback 1) - Reliable secondary option
3. **Kraken** (Fallback 2) - Exchange API
4. **Binance** (Fallback 3) - Exchange API

**Rationale**:
- Developer assessment identified CoinGecko as highest quality crypto API
- Better data consistency and reliability
- Comprehensive coverage of cryptocurrencies
- More stable API endpoints

### 2. Update Frequency Changes

**Previous Options**:
- 30 seconds (removed in V0.99n)
- 1 minute
- 3 minutes
- 5 minutes
- 10 minutes

**New Options** (V0.99n):
- **1 minute** (index 0)
- **3 minutes** (index 1, new default)
- **5 minutes** (index 2)
- **10 minutes** (index 3)

**Default Changed**: 30 seconds ‚Üí **3 minutes**

### 3. Rate Limit Management

**CoinGecko Free Tier Limits**:
- 5-15 calls per minute per IP address
- Rate limits shared across all devices on same network

**Impact Analysis**:

| Devices | Update Interval | Calls/Min | Status |
|---------|----------------|-----------|--------|
| 1-2 | 3 minutes | 0.3-0.7 | ‚úÖ Safe |
| 5 | 3 minutes | 1.7 | ‚úÖ Safe |
| 10 | 3 minutes | 3.3 | ‚úÖ Safe |
| 5 | 1 minute | 5.0 | ‚ö†Ô∏è Limit |
| 10 | 1 minute | 10.0 | ‚ùå Over |

**Why 30s Was Removed**:
- Single device: 2 calls/min (acceptable)
- 5 devices: 10 calls/min (at limit)
- 10 devices: 20 calls/min (exceeds limit)
- Aggressive polling unnecessary for price monitoring
- Increases server load without significant benefit

---

## Implementation Details

### Menu System (menu.cpp)

```cpp
// V0.99n: Removed 30-second option, changed default to 3 minutes
static const char* updateIntervalChoices[] = {
  "1m",   // index 0
  "3m",   // index 1 (new default)
  "5m",   // index 2
  "10m"   // index 3
};

// Default update interval: 3 minutes (index 1)
uint8_t g_updateIntervalIdx = 1;  // Changed from 0 (30s) to 1 (3m)
```

### Web Portal (data/config.html)

```html
<!-- V0.99n: Removed 30-second option -->
<select name="updateInterval" id="updateInterval">
  <option value="0">1 minute</option>
  <option value="1" selected>3 minutes</option>  <!-- New default -->
  <option value="2">5 minutes</option>
  <option value="3">10 minutes</option>
</select>

<!-- Added recommendation note -->
<p style="color:#666; font-size:0.9em; margin-top:5px;">
  üí° Recommended: 3 minutes balances freshness with API rate limits
</p>
```

### API Fallback Chain (network.cpp)

```cpp
// V0.99n: New API priority order
bool fetchCryptoPrice() {
  // Try CoinGecko first (new primary)
  if (fetchCoinGeckoPrice()) {
    g_currentPriceApi = "CoinGecko";
    return true;
  }

  // Fallback to CoinPaprika (was primary)
  if (fetchCoinPaprikaPrice()) {
    g_currentPriceApi = "Paprika";
    return true;
  }

  // Fallback to Kraken
  if (fetchKrakenPrice()) {
    g_currentPriceApi = "Kraken";
    return true;
  }

  // Final fallback to Binance
  if (fetchBinancePrice()) {
    g_currentPriceApi = "Binance";
    return true;
  }

  return false;  // All APIs failed
}
```

---

## Migration Guide

### For Existing Users

**Automatic Migration**:
- Users with 30-second interval will auto-migrate to 1 minute
- Preferences saved in EEPROM will be adjusted on first boot
- No manual configuration required

**Index Mapping**:
```cpp
// Old index ‚Üí New index
// 0 (30s)  ‚Üí 0 (1m)   - closest available
// 1 (1m)   ‚Üí 0 (1m)   - unchanged value
// 2 (3m)   ‚Üí 1 (3m)   - unchanged value
// 3 (5m)   ‚Üí 2 (5m)   - unchanged value
// 4 (10m)  ‚Üí 3 (10m)  - unchanged value
```

**If You Previously Used 30s**:
1. First boot after upgrade sets interval to 1 minute
2. Menu system shows "1m" as selected option
3. Consider changing to 3 minutes for better rate limit safety

### For New Users

**Recommended Settings**:
- **1-2 devices**: 1 minute or 3 minutes
- **3-5 devices**: 3 minutes (default)
- **6+ devices**: 5 minutes or 10 minutes

**Web Portal Configuration**:
1. Connect to device's WiFi or access via local network
2. Navigate to configuration page
3. Update interval defaults to "3 minutes"
4. Adjust based on your device count

---

## User Experience Impact

### Before V0.99n
```
Display shows: "Paprika" (primary API)
Update options: 30s, 1m, 3m, 5m, 10m
Default: 30 seconds
Multi-device risk: High (rate limit exceeded with 10+ devices)
```

### After V0.99n
```
Display shows: "CoinGecko" (new primary API)
Update options: 1m, 3m, 5m, 10m
Default: 3 minutes
Multi-device safety: High (safe up to 10 devices at 3m)
```

### Benefits
- **Better API Quality**: CoinGecko provides more reliable data
- **Rate Limit Safety**: 3-minute default prevents exceeding limits
- **Multi-Device Support**: Safer for users with multiple CryptoBars
- **Bandwidth Efficiency**: Reduced unnecessary API calls
- **Future-Proof**: Room for growth without hitting limits

---

## Technical Specifications

### API Rate Limits

**CoinGecko Free Tier**:
- Rate: 5-15 calls/minute per IP
- Scope: Per IP address (shared across devices)
- Billing: Monthly quota shared globally for demo accounts
- Recommendation: Use for 1-10 devices at 3-minute intervals

**CoinPaprika Free Tier**:
- Rate: 25,000 calls/month
- Scope: Per API key (if using key)
- Fallback: Excellent reliability as secondary source

**Kraken Public API**:
- Rate: 1 call/second (60/minute)
- Scope: Per IP address
- Limitation: Requires trading pair format (XXBTZUSD)

**Binance Public API**:
- Rate: 1200 requests/minute
- Scope: Per IP address
- Limitation: Exchange-specific pairs only

### Update Interval Values

```cpp
// Mapping: index ‚Üí seconds
static const uint32_t updateIntervalValues[] = {
  60,   // index 0: 1 minute
  180,  // index 1: 3 minutes (default)
  300,  // index 2: 5 minutes
  600   // index 3: 10 minutes
};
```

---

## Development History

### Design Decisions

1. **Why CoinGecko First?**
   - Developer assessment: "CoinGecko is the best crypto API"
   - Better coverage of altcoins
   - More consistent data format
   - Active development and support

2. **Why Remove 30s?**
   - Demo account quota shared globally (fatal flaw)
   - Aggressive polling creates thundering herd
   - Price changes are not significant at 30s intervals
   - Users with 5+ devices would exceed limits

3. **Why 3m Default?**
   - Balances freshness (important) with API pressure (critical)
   - Safe for up to 10 devices on same network
   - Matches typical price monitoring use case
   - Reduces risk of hitting rate limits

### Alternative Approaches Considered

**‚ùå Keep 30s with Warning**:
- Rejected: Users might ignore warnings
- Risk: Demo accounts would fail for all users

**‚ùå Dynamic Interval Based on Device Count**:
- Rejected: Too complex for users to understand
- Risk: Requires network discovery (unreliable)

**‚úÖ Remove 30s + Change Default**:
- Simple and safe
- Users can still choose 1m if needed
- Clear recommendation in Web Portal

---

## Files Modified

### Core Configuration
- `include/app_state.h` - Update interval constants
- `src/app_state.cpp` - Default interval index
- `src/menu.cpp` - Menu choices array
- `data/config.html` - Web Portal dropdown + recommendation

### API Priority
- `src/network.cpp` - Reorder API fallback chain
- `src/ui.cpp` - Display updated API names

### Documentation
- `CHANGELOG.md` - V0.99n release notes
- `V0.99n_API_PRIORITY.md` - This file

---

## Testing Checklist

- [ ] Default update interval is 3 minutes on fresh install
- [ ] Menu shows 4 options: 1m, 3m, 5m, 10m
- [ ] Web Portal shows 3 minutes as default (selected)
- [ ] CoinGecko API used as primary source
- [ ] Display shows "CoinGecko" when successful
- [ ] Fallback to CoinPaprika works when CoinGecko fails
- [ ] Existing users with 30s migrate to 1m
- [ ] EEPROM settings preserved after upgrade
- [ ] Serial log shows correct API priority order

---

## Future Enhancements

### Potential Improvements
- **Auto-adjust intervals**: Detect rate limit errors and increase interval
- **Device count awareness**: Recommend intervals based on network devices
- **API health monitoring**: Track success rates per API
- **Custom intervals**: Allow user-defined update frequencies

### Compatibility
- Backward compatible with V0.99m
- Settings migration handled automatically
- No breaking changes to display or features

---

## Recommendations for Users

### Single Device Users
- **Best**: 1 minute (fresh prices)
- **Good**: 3 minutes (default, safe)
- Unlikely to hit rate limits at any interval

### Multi-Device Users (3-5 devices)
- **Best**: 3 minutes (recommended default)
- **Acceptable**: 5 minutes (very safe)
- Avoid 1 minute (approaching rate limits)

### Power Users (10+ devices)
- **Best**: 5 minutes or 10 minutes
- **Risky**: 3 minutes (may hit limits during peak)
- **Avoid**: 1 minute (will exceed limits)

### Network Considerations
- All devices on same WiFi share IP address
- Rate limits apply per IP, not per device
- Consider total household device count
- Corporate/shared networks: use longer intervals

---

## Acknowledgments

Special thanks to:
- Developer feedback identifying CoinGecko as superior API
- User testing revealing rate limit issues with multiple devices
- Community input on update frequency preferences

---

**Version**: V0.99n
**Author**: CryptoBar Development Team
**License**: Same as CryptoBar project
