# CryptoBar V0.99k - Aggregated Market Data & Precision Optimization

## Release Date
2025-12-23

## Overview
This release prioritizes aggregated market data over single-exchange prices and optimizes decimal display precision for better user experience. The system now shows real market prices from 200+ exchanges instead of single exchange data, with intelligent decimal formatting.

## Problem Statement
Previous versions prioritized single exchange APIs (Kraken, Binance) which only show that exchange's price, not the actual market price. Users also saw excessive decimal places (up to 6 digits) that created visual noise.

**Issues:**
- Single exchange prices don't represent true market value
- Kraken only provides 0.1 USD precision for BTC/USD ($88,870.10000)
- CoinGecko returned integer-only prices ($88,900)
- Excessive decimals (6 digits) were noise for regular users
- Update interval presets didn't match common user needs

## Solution

### 1. Aggregated Market Data Priority
Changed API priority to prefer aggregated market data:

**Current Price:**
1. **CoinPaprika** (aggregated from 200+ exchanges, 30s updates, 6 decimal precision)
2. **CoinGecko** (aggregated from 500+ exchanges, 2-5min updates)
3. **Kraken** (single exchange fallback)
4. **Binance** (single exchange fallback)

**Historical Data / Charts / Rolling 24h Line:**
1. **CoinGecko** (aggregated market data)
2. **Binance** (single exchange fallback)
3. **Kraken** (single exchange fallback)

Note: CoinPaprika doesn't provide historical OHLC data, so charts use CoinGecko.

### 2. User-Friendly Decimal Display
- **Maximum 4 decimal places** (down from 6)
- **Dynamic precision detection** - automatically removes trailing zeros
- **Clean display** without .0000 artifacts

### 3. Optimized Update Intervals
Changed from 4 presets to 5 presets matching user needs:
- **Old**: 2m, 3m, 5m, 10m
- **New**: 30s, 1m, 3m, 5m, 10m
- **Default**: 30s (matches CoinPaprika's update frequency)

## Changes

### 1. API Priority Reordering (src/network.cpp)
**Current Price (fetchPrice):**
```cpp
// V0.99k: Prioritize aggregated market data
if (fetchPriceFromPaprika(priceUsd, change24h)) return true;    // 200+ exchanges
if (fetchPriceFromCoingecko(priceUsd, change24h)) return true;  // 500+ exchanges
if (fetchPriceFromKraken(priceUsd, change24h)) return true;     // Single exchange
if (fetchPriceFromBinance(priceUsd, change24h)) return true;    // Single exchange
```

**Historical Data (bootstrapHistory):**
```cpp
// V0.99k: CoinGecko (aggregated) → Binance → Kraken
if (bootstrapHistoryFromCoingeckoMarketChart()) return;
if (bootstrapHistoryFromBinanceKlines()) return;
// Kraken OHLC fallback
```

### 2. Decimal Precision Optimization (src/ui.cpp)
**Dynamic Decimal Detection:**
```cpp
static int detectDecimalPlaces(double price, int maxDecimals) {
  // Analyzes fractional part to determine significant digits
  // Automatically removes trailing zeros
  // Example: 88870.1000 → displays as 88870.1 (1 decimal)
}
```

**Maximum 4 Decimals:**
```cpp
// V0.99k: Max 4 decimals for cleaner display
int maxDecimals = curr.noDecimals ? 0 : 4;  // User-friendly display
int actualDecimals = detectDecimalPlaces(price, maxDecimals);
```

### 3. Update Interval Presets
**app_state.cpp & wifi_portal.cpp:**
```cpp
// V0.99k: 30s, 1min, 3min, 5min, 10min (CoinPaprika supports 30s updates)
const uint32_t UPDATE_PRESETS_MS[] = {
  30UL * 1000UL,   // 30s
  60UL * 1000UL,   // 1min
  180UL * 1000UL,  // 3min
  300UL * 1000UL,  // 5min
  600UL * 1000UL   // 10min
};
const char* UPDATE_PRESET_LABELS[] = { "30s", "1m", "3m", "5m", "10m" };
```

**config.h:**
```cpp
// V0.99k: Default 30 seconds (CoinPaprika update frequency)
static const uint32_t UPDATE_INTERVAL_MS = 30UL * 1000UL;
```

## User Benefits

### 1. Real Market Prices
- **True market value** from 200+ exchanges (not single exchange)
- **Better price discovery** - aggregated data more accurate
- **6 decimal precision** from CoinPaprika ($87,733.576448)
- **Fallback resilience** - 4-layer system ensures price availability

### 2. Cleaner Display
- **Max 4 decimals** eliminates visual noise
- **No trailing zeros** - dynamic precision detection
- **Professional appearance** - easier to read at a glance
- **User quote**: "我個人的顯示四位夠了，再多對普通人來說都是雜訊"

### 3. Flexible Update Frequency
- **30s option** for active traders (matches CoinPaprika)
- **1-10 minute options** for casual monitoring
- **Better battery life** options available
- **Default 30s** balances freshness with API limits

## API Comparison

| API | Type | Precision | Update Freq | Status |
|-----|------|-----------|-------------|--------|
| **CoinPaprika** | Aggregated (200+ exchanges) | 6 decimals | 30s | ✅ Primary price |
| **CoinGecko** | Aggregated (500+ exchanges) | Integer only | 2-5min | ✅ Primary history |
| **Binance** | Single exchange | 0.01 USD | Real-time | ⚠️ US restricted |
| **Kraken** | Single exchange | 0.1 USD | Real-time | ⚠️ Low precision |

## Decimal Display Examples

| API Returns | Old Display (6 dec) | New Display (4 dec max) |
|-------------|---------------------|------------------------|
| $87,733.576448 | $87,733.576448 | $87,733.5764 ✓ |
| $88,870.100000 | $88,870.100000 | $88,870.1 ✓ |
| $88,900.000000 | $88,900.000000 | $88,900 ✓ |
| $42,150.230000 | $42,150.230000 | $42,150.23 ✓ |

## Technical Details

### Precision Improvements
1. **Parsing accuracy**: `strtod()` instead of `atof()` for string-to-double conversion
2. **Dynamic detection**: Analyzes fractional part for significant digits
3. **Adaptive display**: Shows 0-4 decimals based on actual data
4. **No artifacts**: Eliminates .0000 or .5000 binary float artifacts (from V0.99j)

### Update Frequency Analysis
- **CoinPaprika**: 30-second updates → supports 30s interval ✓
- **CoinGecko**: 2-5 minute updates → best for 3-5min intervals
- **User preference**: Flexible 30s-10min range covers all use cases

### Memory & Performance Impact
- Negligible memory increase (array size +1 element)
- No performance impact (same number of API calls)
- Better reliability (aggregated sources more stable)

## Compatibility
- Fully backward compatible with V0.99j
- **Settings migration**: Existing update intervals auto-adjust to nearest preset
- No configuration changes required
- **Open source friendly**: All APIs are free, no API keys needed

## Migration Notes

### From V0.99j → V0.99k
1. Flash V0.99k firmware
2. Update interval may change if it was set to 2min (no longer available)
   - Auto-adjusts to nearest: 30s, 1m, 3m, 5m, or 10m
3. Decimal display automatically becomes cleaner (max 4 decimals)
4. Price source shifts to aggregated data (more accurate)

### What You'll Notice
- ✅ Prices may differ slightly (market average vs single exchange)
- ✅ Decimals are cleaner (4 max, no trailing zeros)
- ✅ New 30s update option in settings menu
- ✅ More stable prices (aggregated data smooths outliers)

## Version History
- V0.99i: Price Update Optimization (API reordering)
- V0.99j: Price Precision Fix (float → double)
- V0.99k: Aggregated Market Data & Precision Optimization (this release)

## Files Modified

### Core Changes
- `src/network.cpp`: API priority reordering for price and history
- `src/ui.cpp`: Decimal precision limit (6 → 4), dynamic detection
- `include/config.h`: Default interval (undefined → 30s)
- `src/app_state.cpp`: 5 presets (30s, 1m, 3m, 5m, 10m)
- `src/wifi_portal.cpp`: Web portal presets matching firmware
- `include/app_state.h`: UPDATE_PRESETS_COUNT (4 → 5)

### Debug Improvements
- Added raw JSON logging for all API calls
- Better error messages showing which API failed/succeeded

## User Feedback
> "我個人的顯示四位夠了，再多對普通人來說都是雜訊"
> (Translation: "4 decimals is enough for me, more is just noise for regular users")

> "我更希望能看到大盤價"
> (Translation: "I prefer seeing the overall market price")

## Verification

After flashing V0.99k, you should see:

1. **Serial Monitor**:
   ```
   [CP] BTC: $87733.5764 (24h: -0.97%)  // CoinPaprika with 4 decimals
   ```

2. **Settings Menu**: 5 update options (30s, 1m, 3m, 5m, 10m)

3. **Price Display**: Max 4 decimals, no trailing zeros

4. **Aggregated Data**: Prices may differ from single exchange (expected)

## Known Limitations

1. **CoinPaprika History**: No OHLC API, so charts use CoinGecko (still aggregated)
2. **CoinGecko Precision**: Integer-only prices (fallback only)
3. **Update Frequency**: 30s requires CoinPaprika success; duplicates OK if fails

## Future Improvements

Potential enhancements for future versions:
- [ ] Add more aggregated data sources
- [ ] Implement price averaging across multiple APIs
- [ ] Add user-configurable decimal precision
- [ ] Support for more update interval customization
