# V0.99m: API Source Display

**Release Date**: 2025-12-24
**Focus**: Dynamic API source transparency and UI layout optimization

---

## Overview

V0.99m introduces real-time API source indication in the left black panel, providing full transparency about data sources. The display automatically updates when API fallback occurs, showing users exactly which service is providing their cryptocurrency data.

---

## Key Features

### 1. Dynamic API Source Display

The left black panel now displays the actual API sources being used:

```
┌─────────────────┐
│ Paprika    ← Price API (dynamic)
│ USD        ← Currency
│ **BTC**    ← Coin symbol (centered)
│ -0.54%     ← 24h change
│ CoinGecko  ← History API (dynamic)
└─────────────────┘
```

**Real-time Updates**:
- Changes automatically when fallback occurs
- No user action required
- Always shows current data source

### 2. API Fallback Chain

**Price Data** (Real-time quotes):
1. **CoinPaprika** (Primary) → Displays "Paprika"
2. CoinGecko (Fallback 1) → Displays "CoinGecko"
3. Kraken (Fallback 2) → Displays "Kraken"
4. Binance (Fallback 3) → Displays "Binance"

**Historical Data** (Charts):
1. **CoinGecko** (Primary) → Displays "CoinGecko"
2. Binance (Fallback 1) → Displays "Binance"
3. Kraken (Fallback 2) → Displays "Kraken"

### 3. Optimized Layout

**Vertical Spacing** (128px display height):
- **Paprika label**: 22px gap below (extra breathing room)
- **USD ↔ BTC**: 7px gap (balanced spacing)
- **BTC ↔ %**: 7px gap (balanced spacing)
- **% ↔ CoinGecko**: 4px gap (compact bottom)

**Centering Algorithm**:
```cpp
// BTC visual center = display.height() / 2 (64px)
// BTC baseline = center - sy1 - sH/2
// Other elements calculated from BTC baseline using:
//   Upper: baseline - (height + gap)
//   Lower: baseline + (gap + height)
```

---

## Implementation Details

### Global Variables (app_state.h/cpp)

```cpp
// Track currently-used APIs
extern const char* g_currentPriceApi;    // "Paprika", "Kraken", etc.
extern const char* g_currentHistoryApi;  // "CoinGecko", "Binance", etc.

// Default values
const char* g_currentPriceApi = "Paprika";
const char* g_currentHistoryApi = "CoinGecko";
```

### API Tracking (network.cpp)

Each API fetch function updates the global variable on success:

```cpp
// CoinPaprika price fetch
if (priceUsd > 0.0) {
  g_currentPriceApi = "Paprika";
}

// CoinGecko history fetch
if (kept > 0) {
  g_currentHistoryApi = "CoinGecko";
}
```

### UI Rendering (ui.cpp)

```cpp
// Read current API sources (updated by network.cpp)
const char* priceApiLabel = g_currentPriceApi;
const char* historyApiLabel = g_currentHistoryApi;

// Calculate layout with BTC centered
int16_t btcCenter = display.height() / 2;
int16_t sy = btcCenter - sy1 - sH / 2;

// Draw labels with actual API names
display.print(priceApiLabel);    // "Paprika" or current source
display.print(historyApiLabel);  // "CoinGecko" or current source
```

---

## User Experience

### Normal Operation
```
Paprika      ← Default price source
USD
BTC
-0.54%
CoinGecko    ← Default history source
```

### During Fallback
```
Kraken       ← Switched to Kraken (CoinPaprika unavailable)
USD
BTC
-0.54%
Binance      ← Switched to Binance (CoinGecko unavailable)
```

### Benefits
- **Transparency**: Always know your data source
- **Reliability**: See fallback in action
- **Trust**: Verify data origin
- **Debugging**: Identify API issues quickly

---

## Technical Specifications

### Font Sizes
- **API labels**: 6x8 default font (extra small)
- **Currency/Change**: FreeSansBold9pt7b (small)
- **Coin symbol**: FreeSansBold18pt7b (large)

### Layout Constants
```cpp
const int topApiGap = 22;      // Paprika ↔ USD
const int normalGap = 7;       // USD ↔ BTC, BTC ↔ %
const int bottomApiGap = 4;    // % ↔ CoinGecko
```

### Display Dimensions
- **Panel width**: 90px
- **Display height**: 128px
- **BTC center**: 64px (vertical midpoint)

---

## Development History

### Iteration Process
1. **Initial implementation**: Fixed labels ("Paprika", "CoinGecko")
2. **Spacing issues**: Text crowded together
3. **Centering problems**: BTC not in true center
4. **Final refinement**: Correct baseline formula + asymmetric gaps

### Commits
1. Add API source display (initial)
2. Improve spacing (4px → 7px gaps)
3. Increase spacing (7px → asymmetric)
4. Fix BTC centering (baseline formula)
5. Move Paprika up 4px
6. Move Paprika up another 4px
7. Implement dynamic API tracking
8. Documentation update

---

## Files Modified

### Core Changes
- `include/app_state.h` - Add API tracking variables
- `src/app_state.cpp` - Define and initialize variables
- `src/network.cpp` - Update API tracking on fetch success
- `src/ui.cpp` - Dynamic label rendering

### Documentation
- `CHANGELOG.md` - V0.99m release notes
- `V0.99m_API_SOURCE_DISPLAY.md` - This file

---

## Future Enhancements

### Potential Improvements
- **Error indicators**: Show API failure states
- **Latency display**: Show response times
- **API selection menu**: Manual API preference
- **Status history**: Log API switches

### Compatibility
- Backward compatible with V0.99l
- No breaking changes to existing features
- Existing settings preserved

---

## Testing Checklist

- [ ] Normal operation shows "Paprika" + "CoinGecko"
- [ ] CoinPaprika failure switches to fallback
- [ ] CoinGecko failure switches to fallback
- [ ] BTC symbol visually centered
- [ ] All text properly spaced
- [ ] No text overlap or clipping
- [ ] API labels update on fallback
- [ ] Serial log shows correct API usage

---

## Acknowledgments

Special thanks to user feedback for identifying:
- Baseline calculation errors
- Spacing optimization needs
- Importance of data source transparency

---

**Version**: V0.99m
**Author**: CryptoBar Development Team
**License**: Same as CryptoBar project
