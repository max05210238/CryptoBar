# CryptoBar V0.99r - Settings Bug Fix & UX Improvements

## Release Date
2025-12-28

## Overview
This release fixes a critical array bounds bug that caused system restarts when selecting the 10-minute update interval, and improves the update interval selection UX by implementing a submenu pattern.

## Problem Statement

### Critical Bug: System Restart on 10-Minute Setting
**Symptoms:**
- Setting update interval to 10 minutes → system restarts
- After reboot, device shows 10-minute setting correctly
- Attempting to change from 10 minutes to any other interval → system restarts again

**Root Cause:**
Array bounds violation in update interval presets:
- `UPDATE_PRESETS_COUNT` was defined as `5` (expecting 5 presets)
- Actual array only contained `4` elements: 1m, 3m, 5m, 10m
- When user pressed button at 10-minute setting (index 3):
  - Code calculated next index: `(3 + 1) % 5 = 4`
  - Attempted to access `UPDATE_PRESETS_MS[4]` (out of bounds)
  - Read garbage memory → ESP32 watchdog triggered → system restart
- Saved invalid index to NVS, causing restart loop on subsequent changes

**Impact:**
- **CRITICAL**: Device becomes unusable when 10-minute interval is selected
- Users experience unexpected restarts and data loss
- Potential corruption of saved settings in NVS

### UX Issue: Accidental Data Fetching
**Problem:**
- Update interval setting used direct toggle pattern (press → immediate change)
- Each change immediately triggered:
  1. Save settings to NVS
  2. Reset scheduler
  3. Force price refresh
- Users exploring options accidentally triggered multiple API requests
- Increased system load and API pressure

## Solution

### 1. Fix Array Bounds Bug
Changed `UPDATE_PRESETS_COUNT` from 5 to 4 to match actual array size:

**Before (BROKEN):**
```cpp
// include/app_state.h
#define UPDATE_PRESETS_COUNT 5  // WRONG: declares 5 elements

// src/app_state.cpp
const uint32_t UPDATE_PRESETS_MS[] = {
  60UL * 1000UL,   // 1min
  180UL * 1000UL,  // 3min
  300UL * 1000UL,  // 5min
  600UL * 1000UL   // 10min
};  // Only 4 elements! Index 4 is out of bounds
```

**After (FIXED):**
```cpp
// include/app_state.h
#define UPDATE_PRESETS_COUNT 4  // CORRECT: matches array size

// src/app_state.cpp
const uint32_t UPDATE_PRESETS_MS[] = {
  60UL * 1000UL,   // 1min
  180UL * 1000UL,  // 3min
  300UL * 1000UL,  // 5min
  600UL * 1000UL   // 10min
};  // 4 elements, indices 0-3 are valid
```

### 2. Implement Update Interval Submenu
Changed update interval from direct toggle to submenu pattern (matching coin/currency/timezone selection):

**Before (Direct Toggle - Poor UX):**
```cpp
case MENU_UPDATE_INTERVAL:
  g_updatePresetIndex = (g_updatePresetIndex + 1) % presetCount;  // Immediate change
  g_updateIntervalMs = UPDATE_PRESETS_MS[g_updatePresetIndex];
  saveSettings();          // Saves immediately
  tickSchedulerReset();    // Resets scheduler immediately
  lastUpdate = millis();   // Triggers data fetch immediately
  break;
```

**After (Submenu - Better UX):**
```cpp
case MENU_UPDATE_INTERVAL:
  // Enter submenu (user can browse without triggering changes)
  g_uiMode = UI_MODE_UPDATE_SUB;
  g_updateMenuIndex = g_updatePresetIndex;  // Start at current setting
  drawUpdateMenu(false);
  break;

// Selection only applied when user confirms (presses button in submenu)
void handleUpdateIntervalSelect() {
  g_updatePresetIndex = g_updateMenuIndex;
  g_updateIntervalMs = UPDATE_PRESETS_MS[g_updatePresetIndex];
  saveSettings();          // Only saves on confirmation
  tickSchedulerReset();    // Only resets on confirmation
  lastUpdate = millis();   // Only triggers fetch on confirmation
  g_uiMode = UI_MODE_MENU; // Return to main menu
}
```

**Benefits:**
- ✅ Users can browse options without triggering settings changes
- ✅ No accidental API requests while exploring
- ✅ Consistent UX with other submenus (coin, currency, timezone)
- ✅ Reduces system load and API pressure
- ✅ Long press to cancel returns to main menu

## Changes

### Core Files Modified

#### 1. Array Bounds Fix
**include/app_state.h:**
```cpp
// V0.99r: Update interval presets: 1min, 3min, 5min, 10min (fixed array bounds bug)
#define UPDATE_PRESETS_COUNT 4
```

**src/app_state.cpp:**
```cpp
// V0.99r: 1min, 3min, 5min, 10min (4 presets, fixed array bounds bug)
const uint32_t UPDATE_PRESETS_MS[] = {
  60UL * 1000UL,   // 1min
  180UL * 1000UL,  // 3min (default, recommended)
  300UL * 1000UL,  // 5min
  600UL * 1000UL   // 10min
};
const char* UPDATE_PRESET_LABELS[] = { "1m", "3m", "5m", "10m" };
```

#### 2. Update Interval Submenu Infrastructure
**include/app_state.h:**
```cpp
// Add new UI mode
enum UiMode {
  // ... existing modes ...
  UI_MODE_UPDATE_SUB = 8   // V0.99r: Update interval submenu
};

// Add submenu state tracking
extern int g_updateMenuIndex;
extern int g_updateMenuTopIndex;
extern bool g_updateDirty;
```

**src/app_state.cpp:**
```cpp
// Initialize submenu state
int g_updateMenuIndex    = 0;
int g_updateMenuTopIndex = 0;
bool g_updateDirty       = false;
```

#### 3. UI Components
**include/ui.h:**
```cpp
// Update interval selection submenu (V0.99r)
void drawUpdateMenu(bool fullRefresh);
void ensureUpdateMenuVisible();
```

**src/ui_update.cpp (NEW FILE):**
- Implements update interval submenu UI
- Displays 4 options: 1m, 3m, 5m, 10m
- Follows same pattern as coin/currency submenus

#### 4. Menu Handling
**src/app_menu.cpp:**
```cpp
// Changed MENU_UPDATE_INTERVAL from direct toggle to submenu entry
case MENU_UPDATE_INTERVAL: {
  g_uiMode = UI_MODE_UPDATE_SUB;
  g_updateMenuIndex = g_updatePresetIndex;
  drawUpdateMenu(false);
  break;
}

// New handler for submenu selection
void handleUpdateIntervalSelect() {
  g_updatePresetIndex = g_updateMenuIndex;
  g_updateIntervalMs = UPDATE_PRESETS_MS[g_updatePresetIndex];
  saveSettings();
  tickSchedulerReset("MENU_UPD");
  g_uiMode = UI_MODE_MENU;
}
```

#### 5. Input Handling
**src/app_input.cpp:**
```cpp
// Handle short press in update submenu
else if (g_uiMode == UI_MODE_UPDATE_SUB) {
  handleUpdateIntervalSelect();
}

// Handle long press to cancel
if (g_uiMode == UI_MODE_UPDATE_SUB) {
  leaveMenu();  // Return to main menu without saving
}
```

#### 6. Encoder Navigation
**src/main.cpp:**
```cpp
// Handle rotary encoder in update submenu
else if (g_uiMode == UI_MODE_UPDATE_SUB) {
  g_updateMenuIndex += steps;
  while (g_updateMenuIndex < 0) g_updateMenuIndex += UPDATE_PRESETS_COUNT;
  while (g_updateMenuIndex >= UPDATE_PRESETS_COUNT) g_updateMenuIndex -= UPDATE_PRESETS_COUNT;
  ensureUpdateMenuVisible();
  g_updateDirty = true;
}

// Throttle submenu redraw
else if (g_uiMode == UI_MODE_UPDATE_SUB && g_updateDirty) {
  drawUpdateMenu(false);
  g_updateDirty = false;
}
```

## Testing Checklist

### Critical Bug Verification
- [ ] Set update interval to 10 minutes → no restart
- [ ] Change from 10 minutes to 1 minute → no restart
- [ ] Change from 10 minutes to 3 minutes → no restart
- [ ] Change from 10 minutes to 5 minutes → no restart
- [ ] Reboot with 10-minute setting saved → boots correctly
- [ ] Change interval after reboot → no restart

### Submenu UX Verification
- [ ] Enter update interval submenu → displays all 4 options
- [ ] Rotate encoder → highlights different options
- [ ] Short press → applies selection and returns to menu
- [ ] Long press → cancels and returns to menu without saving
- [ ] Browse options multiple times → no API requests until confirmation
- [ ] Selected interval displays correctly in main menu
- [ ] Scheduler resets only after confirmation

### Regression Testing
- [ ] Coin submenu still works correctly
- [ ] Currency submenu still works correctly
- [ ] Timezone submenu still works correctly
- [ ] All other menu items unchanged
- [ ] Settings persist across reboots
- [ ] Price updates continue at selected interval

## Upgrade Notes

### For Users
**IMPORTANT:** This release fixes a critical bug that caused restarts. Update immediately if you use or plan to use 10-minute update intervals.

**Changes you'll notice:**
1. **Update interval is now a submenu** (like coin selection)
   - Press button on "Update: Xm" → enter submenu
   - Rotate to browse options (1m, 3m, 5m, 10m)
   - Short press → apply selection
   - Long press → cancel and return
2. **No more accidental data fetches** when exploring options
3. **10-minute interval now works correctly** (no restart)

### For Developers
**Breaking Changes:**
- `UPDATE_PRESETS_COUNT` reduced from 5 to 4
- Update interval now uses submenu pattern (requires UI mode handling)

**New Files:**
- `src/ui_update.cpp` - Update interval submenu UI

**Modified Files:**
- `include/app_state.h` - Added UI_MODE_UPDATE_SUB, submenu state
- `src/app_state.cpp` - Fixed array size, added submenu state
- `src/app_menu.cpp` - Changed to submenu pattern
- `src/app_input.cpp` - Handle submenu selection
- `src/main.cpp` - Handle encoder navigation in submenu
- `include/ui.h` - Added submenu UI functions

## Version History
- **V0.99q**: UI/UX improvements (time refresh)
- **V0.99r**: **Settings bug fix & UX improvements** (THIS RELEASE)

## Credits
Bug reported by user experiencing restart issues when selecting 10-minute update interval.

## Security Notes
This release fixes a memory safety issue (array bounds violation). Update is recommended for all users to prevent potential crashes and undefined behavior.
