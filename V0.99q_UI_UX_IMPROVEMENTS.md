# CryptoBar V0.99q - UI/UX Improvements: Time Refresh & Settings Fix

**Release Date:** 2024-12-25

## Overview

V0.99q addresses three important UI/UX issues:
1. **Fixed WiFi Portal settings not being applied** - All advanced settings from the web portal now properly apply to the device
2. **Fixed timezone menu ordering** - Web portal timezone list now displays in UTC order (matching the device settings menu)
3. **Added independent time refresh** - Clock updates every minute regardless of price refresh interval, perfect for use as a desk clock

---

## üéØ What's New

### 1. WiFi Portal Settings Application Fix

**Problem:** When users configured advanced settings through the WiFi provisioning portal (refresh mode, update interval, brightness, time/date format, currency, timezone, day average mode), these settings were submitted but **never applied** to the device. Only coin selection and date/time size were working.

**Solution:**
- Added proper handling for all portal settings in `main.cpp` (lines 507-567)
- All advanced settings now correctly apply during WiFi provisioning
- Serial logging added for each applied setting

**Settings now working:**
- ‚úÖ Refresh Mode (rfMode): Partial/Full refresh
- ‚úÖ Update Preset (updPreset): 1m/3m/5m/10m intervals
- ‚úÖ Brightness Preset (briPreset): Low/Med/High
- ‚úÖ Time Format (timeFmt): 24h/12h
- ‚úÖ Date Format (dateFmt): MM/DD, DD/MM, YYYY-MM-DD
- ‚úÖ Display Currency (dispCur): USD, TWD, EUR, GBP, CAD, JPY, KRW, SGD, AUD
- ‚úÖ Timezone (tzIndex): All 27 timezones
- ‚úÖ Day Average Mode (dayAvg): Off, Rolling 24h, ET 7pm cycle

**Files Changed:**
- `src/main.cpp` (lines 507-567)

---

### 2. Web Portal Timezone Menu UTC Ordering

**Problem:** The device settings menu displayed timezones in UTC order (UTC-12 to UTC+14), but the web portal displayed them in legacy array order, causing confusion.

**Solution:**
- Modified web portal timezone dropdown to use `TIMEZONE_DISPLAY_ORDER[]` array
- Timezone list now displays in UTC order: UTC-12 ‚Üí UTC+14
- Consistent with device settings menu behavior

**Files Changed:**
- `src/wifi_portal.cpp` (lines 381-389)

**Example ordering:**
```
UTC-12 Baker Island
UTC-11 American Samoa
...
UTC+00 London
UTC+01 Berlin
...
UTC+13 Apia
UTC+14 Kiritimati
```

---

### 3. Independent Time Refresh Mechanism

**Problem:** With long price update intervals (e.g., 5-10 minutes), the clock wouldn't update for the entire interval, making CryptoBar unsuitable as a desk clock.

**Solution:**
- Added independent minute-aligned time refresh
- Clock updates every minute via partial refresh
- Time refreshes **do NOT count** toward the 20-refresh partial limit
- Price updates continue on their own schedule

**Implementation Details:**

#### New Global Variables (`app_state.h/cpp`):
```cpp
time_t g_nextTimeRefreshUtc;   // Next time-only refresh timestamp
bool   g_timeRefreshEnabled;    // Enable/disable (default: true)
```

#### New UI Function (`ui.h/cpp`):
```cpp
void drawMainScreenTimeOnly(bool fullRefresh = false);
```
- Partial window: 50-pixel height at top of white panel
- Updates only date/time area
- Does not redraw price, chart, or symbol panel

#### Main Loop Logic (`main.cpp`):
1. **Time Refresh Check** (line 813-837):
   - Runs every loop iteration
   - Checks if current time ‚â• next scheduled time refresh
   - Aligns to minute boundaries: `(nowUtc / 60 + 1) * 60`
   - Calls `drawMainScreenTimeOnly(false)` for partial refresh
   - Does NOT increment `g_partialRefreshCount`

2. **Reset After Price Update** (line 999-1003):
   - When price updates, time also updates
   - Resets `g_nextTimeRefreshUtc` to next minute boundary
   - Prevents duplicate time refresh immediately after price update

**Example Timeline** (5-minute price refresh, Full refresh mode):
```
10:00 ‚Üí Price refresh (FULL) + reset time scheduler
10:01 ‚Üí Time partial refresh (not counted)
10:02 ‚Üí Time partial refresh (not counted)
10:03 ‚Üí Time partial refresh (not counted)
10:04 ‚Üí Time partial refresh (not counted)
10:05 ‚Üí Price refresh (FULL) + reset time scheduler
10:06 ‚Üí Time partial refresh (not counted)
...
```

**Files Changed:**
- `include/app_state.h` (lines 224-227)
- `src/app_state.cpp` (lines 201-203)
- `include/ui.h` (lines 58-60)
- `src/ui.cpp` (lines 955-985)
- `src/main.cpp` (lines 813-837, 999-1003)

---

## üìã Technical Summary

### Files Modified (7 files)

1. **src/main.cpp**
   - Added WiFi portal settings application (lines 507-567)
   - Added independent time refresh logic (lines 813-837)
   - Added time refresh reset after price update (lines 999-1003)
   - Updated version comment to V0.99q

2. **src/wifi_portal.cpp**
   - Fixed timezone menu UTC ordering (lines 381-389)

3. **include/app_state.h**
   - Added time refresh global variables (lines 224-227)

4. **src/app_state.cpp**
   - Defined time refresh global variables (lines 201-203)
   - Updated version to V0.99q

5. **include/ui.h**
   - Added `drawMainScreenTimeOnly()` declaration (lines 58-60)

6. **src/ui.cpp**
   - Implemented `drawMainScreenTimeOnly()` function (lines 955-985)

7. **V0.99q_UI_UX_IMPROVEMENTS.md** (new file)
   - This changelog

---

## üîß Configuration

### Enabling/Disabling Time Refresh

Time refresh is enabled by default (`g_timeRefreshEnabled = true`). To disable:

```cpp
// In setup() or anywhere before loop()
g_timeRefreshEnabled = false;
```

### Time Refresh Partial Window

The time-only refresh uses a 50-pixel height window:
```cpp
const int TIME_AREA_HEIGHT = 50;  // ui.cpp line 962
```

This is sufficient for both Small (6x8 font) and Large (9pt font) date/time modes.

---

## üêõ Bug Fixes

1. **WiFi Portal Settings Not Applied**
   - **Impact:** Users couldn't configure device settings during initial setup
   - **Status:** ‚úÖ Fixed - all 9 advanced settings now properly apply

2. **Timezone Menu Ordering Inconsistency**
   - **Impact:** Confusion when selecting timezone (device vs portal had different ordering)
   - **Status:** ‚úÖ Fixed - both use UTC-sorted order

3. **Clock Not Updating with Long Price Intervals**
   - **Impact:** CryptoBar couldn't serve as a desk clock with 5-10 minute price intervals
   - **Status:** ‚úÖ Fixed - clock now updates every minute independently

---

## üìä Testing Checklist

- [x] Compile without errors
- [ ] WiFi portal settings apply correctly
  - [ ] Refresh mode changes
  - [ ] Update interval changes
  - [ ] Brightness changes
  - [ ] Time/date format changes
  - [ ] Currency changes
  - [ ] Timezone changes
  - [ ] Day average mode changes
- [ ] Web portal timezone list displays in UTC order
- [ ] Time refreshes every minute (independent of price)
- [ ] Time refresh doesn't count toward partial limit
- [ ] Price updates reset time refresh schedule

---

## üéÅ User Benefits

1. **Complete First-Time Setup**: Users can now fully configure their device through the WiFi portal without needing to access the physical menu
2. **Consistent Timezone Selection**: No more confusion between device and portal timezone ordering
3. **Desk Clock Functionality**: CryptoBar can now serve as a reliable desk clock even with conservative 10-minute price update intervals
4. **Battery-Friendly**: Time refreshes use small partial updates (50px height), minimal e-ink wear

---

## üìù Migration Notes

**From V0.99p ‚Üí V0.99q:**
- No breaking changes
- No NVS format changes
- All existing settings preserved
- Time refresh is automatic, no user action required

---

## üîÆ Future Enhancements

Possible improvements for future versions:
- User-configurable time refresh interval (currently fixed at 1 minute)
- Optional seconds display with faster refresh rate
- Disable time refresh during sleep hours
- Time-only mode (hide price/chart, show only clock)

---

## üìÑ Version History

- **V0.99p** (2024-12-XX): High-Precision Price Display
- **V0.99q** (2024-12-25): UI/UX Improvements: Time Refresh & Settings Fix

---

## üôè Credits

**Developer:** Claude (Anthropic)
**Project:** CryptoBar - ESP32-S3 Cryptocurrency Price Ticker
**Hardware:** Waveshare 2.9" e-Paper Display
**Platform:** PlatformIO + ESP32-S3-DevKitC-1
